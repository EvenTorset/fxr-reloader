export enum Weapon {
  Unarmed = 110000,
  Dagger = 1000000,
  BlackKnife = 1010000,
  ParryingDagger = 1020000,
  Misericorde = 1030000,
  Reduvia = 1040000,
  BloodstainedDagger = 1140000,
  CrystalKnife = 1050000,
  GlintstoneKris = 1070000,
  ScorpionsStinger = 1080000,
  GreatKnife = 1090000,
  Wakizashi = 1100000,
  IvorySickle = 1130000,
  ErdsteelDagger = 1150000,
  BladeOfCalling = 1160000,
  ShortSword = 2010000,
  Broadsword = 2020000,
  BanishedKnightsGreatsword = 3080000,
  AlabasterLordsSword = 3070000,
  CleanrotKnightsSword = 5010000,
  WatchdogsGreatsword = 4010000,
  NoblesSlenderSword = 2230000,
  BlasphemousBlade = 3140000,
  WeatheredStraightSword = 2050000,
  OrnamentalStraightSword = 2060000,
  GoldenEpitaph = 2070000,
  NoxFlowingSword = 2080000,
  RegaliaOfEochaid = 2220000,
  CodedSword = 2110000,
  SwordOfNightAndFlame = 2140000,
  CrystalSword = 2150000,
  CarianKnightsSword = 2180000,
  CaneSword = 2210000,
  MiquellanKnightsSword = 2200000,
  SwordOfStTrina = 2190000,
  WarhawksTalon = 2240000,
  LazuliGlintstoneSword = 2250000,
  RottenCrystalSword = 2260000,
  Rapier = 5020000,
  RogiersRapier = 5030000,
  NoblesEstoc = 5060000,
  AntspurRapier = 5040000,
  FrozenNeedle = 5050000,
  Estoc = 5000000,
  GodskinStitcher = 6010000,
  BloodyHelice = 6000000,
  GreatEpee = 6020000,
  DragonKingsCragblade = 6040000,
  Scimitar = 7140000,
  Falchion = 7000000,
  Shotel = 7020000,
  OnyxLordsGreatsword = 8010000,
  ForkedHatchet = 14010000,
  Shamshir = 7030000,
  BanditsCurvedSword = 7040000,
  MonksFlameblade = 8070000,
  MagmaBlade = 7050000,
  CelebrantsSickle = 1060000,
  Cinquedea = 1110000,
  FlowingCurvedSword = 7060000,
  WingOfAstel = 7070000,
  ScavengersCurvedSword = 7080000,
  EclipseShotel = 7100000,
  SerpentGodsCurvedSword = 7110000,
  MantisBlade = 7120000,
  Grossmesser = 7150000,
  Dismounter = 8020000,
  BloodhoundsFang = 8030000,
  StarscourgeGreatsword = 4050000,
  MagmaWyrmsScalesword = 8040000,
  ZamorCurvedSword = 8050000,
  OmenCleaver = 8060000,
  MorgottsCursedSword = 8100000,
  BeastmansCurvedSword = 7010000,
  BeastmansCleaver = 8080000,
  Uchigatana = 9000000,
  Nagakiba = 9010000,
  HandOfMalenia = 9020000,
  MeteoricOreBlade = 9030000,
  RiversOfBlood = 9040000,
  Moonveil = 9060000,
  SerpentboneBlade = 9080000,
  DragonscaleBlade = 9070000,
  BastardSword = 3000000,
  Claymore = 3180000,
  RoyalGreatsword = 4060000,
  MalikethsBlackBlade = 4020000,
  ForkedGreatsword = 3010000,
  IronGreatsword = 3020000,
  LordswornsGreatsword = 3030000,
  TrollsGoldenSword = 4030000,
  KnightsGreatsword = 3040000,
  Flamberge = 3050000,
  Zweihander = 4040000,
  Greatsword = 4000000,
  OrdovissGreatsword = 3060000,
  InseparableSword = 2090000,
  DarkMoonGreatsword = 3090000,
  SacredRelicSword = 3100000,
  HelphensSteeple = 3130000,
  GodslayersGreatsword = 4070000,
  RuinsGreatsword = 4080000,
  MaraisExecutionersSword = 3150000,
  GraftedBladeGreatsword = 4100000,
  GoldenOrderGreatsword = 3170000,
  SwordOfMilos = 3160000,
  GargoylesGreatsword = 3190000,
  TrollKnightsSword = 4110000,
  DeathsPoker = 3200000,
  GargoylesBlackblade = 3210000,
  HandAxe = 14020000,
  BattleAxe = 14000000,
  JawboneAxe = 14030000,
  IronCleaver = 14040000,
  RippleBlade = 14050000,
  CelebrantsCleaver = 14060000,
  WarpedAxe = 15010000,
  GreatOmenkillerCleaver = 15020000,
  RustedAnchor = 15060000,
  IcerindHatchet = 14080000,
  HighlandAxe = 14100000,
  SacrificialAxe = 14110000,
  RosusAxe = 14120000,
  StormhawkAxe = 14140000,
  Greataxe = 15000000,
  CrescentMoonAxe = 15030000,
  WingedGreathorn = 15110000,
  DuelistGreataxe = 23040000,
  AxeOfGodfrey = 23050000,
  AxeOfGodrick = 15040000,
  ExecutionersGreataxe = 15080000,
  ButcheringKnife = 15120000,
  GargoylesGreatAxe = 15130000,
  GargoylesBlackAxe = 15140000,
  Club = 11010000,
  Mace = 11000000,
  GreathornHammer = 12010000,
  BattleHammer = 12020000,
  CurvedClub = 11030000,
  MonksFlamemace = 11090000,
  WatchdogsStaff = 23010000,
  Warpick = 11040000,
  MorningStar = 11050000,
  VarresBouquet = 11060000,
  SpikedClub = 11070000,
  Hammer = 11080000,
  ScepterOfTheAllKnowing = 11110000,
  NoxFlowingHammer = 11120000,
  RingedFinger = 11130000,
  StoneClub = 11140000,
  MarikasHammer = 11150000,
  LargeClub = 12000000,
  GreatClub = 23020000,
  GreatMace = 12060000,
  DragonGreatclaw = 23060000,
  CurvedGreatClub = 12080000,
  PrelatesInfernoCrozier = 23000000,
  CelebrantsSkull = 12130000,
  Pickaxe = 12140000,
  BeastclawGreathammer = 12150000,
  CranialVesselCandlestand = 12170000,
  GreatStars = 12180000,
  BrickHammer = 12190000,
  StaffOfTheAvatar = 23070000,
  FallingstarBeastJaw = 23080000,
  GhizasWheel = 23100000,
  GiantCrusher = 23110000,
  DevourersScepter = 12200000,
  TrollsHammer = 23130000,
  RottenStaff = 23140000,
  RottenGreataxe = 23150000,
  RottenBattleHammer = 12210000,
  Spear = 16010000,
  CrystalSpear = 16020000,
  GuardiansSwordspear = 18110000,
  ClaymansHarpoon = 16030000,
  CleanrotSpear = 16040000,
  PestsGlaive = 18010000,
  MohgwynsSacredSpear = 17010000,
  IronSpear = 16150000,
  Partisan = 16050000,
  CelebrantsRibRake = 16060000,
  Pike = 16070000,
  SiluriasTree = 17020000,
  BoltOfGransax = 16090000,
  CrossNaginata = 16110000,
  DeathRitualSpear = 16120000,
  InquisitorsGirandole = 16130000,
  SerpentHunter = 17030000,
  VykesWarSpear = 17050000,
  Lance = 17060000,
  Treespear = 17070000,
  Lucerne = 18020000,
  BanishedKnightsHalberd = 18030000,
  CommandersStandard = 18040000,
  NightriderGlaive = 18050000,
  LonghaftAxe = 15050000,
  RippleCrescentHalberd = 18060000,
  VulgarMilitiaSaw = 18070000,
  GolemsHalberd = 23120000,
  GoldenHalberd = 18080000,
  Glaive = 18090000,
  LorettasWarSickle = 18100000,
  SpikedSpear = 16140000,
  DragonHalberd = 18140000,
  GargoylesHalberd = 18150000,
  RottenCrystalSpear = 16160000,
  GargoylesBlackHalberd = 18160000,
  Scythe = 19000000,
  GraveScythe = 19010000,
  HaloScythe = 19020000,
  VulgarMilitiaShotel = 18130000,
  WingedScythe = 19060000,
  Twinblade = 10000000,
  GodskinPeeler = 10010000,
  EleonorasPoleblade = 10050000,
  TwinnedKnightSwords = 10030000,
  GargoylesTwinblade = 10080000,
  GargoylesBlackBlades = 10090000,
  Caestus = 21000000,
  VenomousFang = 22010000,
  Hookclaws = 22000000,
  SpikedCaestus = 21010000,
  BloodhoundClaws = 22020000,
  Katar = 21100000,
  ClingingBone = 21110000,
  VeteransProsthesis = 21120000,
  GraftedDragon = 21060000,
  RaptorTalons = 22030000,
  IronBall = 21070000,
  CipherPata = 21130000,
  StarFist = 21080000,
  Whip = 20000000,
  ThornedWhip = 20020000,
  MagmaWhipCandlestick = 20030000,
  HoslowsPetalWhip = 20050000,
  GiantsRedBraid = 20060000,
  Urumi = 20070000,
  Flail = 13010000,
  NightriderFlail = 13000000,
  FamilyHeads = 13020000,
  BastardsStars = 13030000,
  ChainlinkFlail = 13040000,
  CrystalStaff = 33040000,
  GelmirGlintstoneStaff = 33050000,
  DemiHumanQueensStaff = 33060000,
  GlintstoneStaff = 33000000,
  StaffOfTheGuilty = 33260000,
  DiggersStaff = 33120000,
  AstrologersStaff = 33130000,
  AcademyGlintstoneStaff = 33200000,
  CarianGlintstoneStaff = 33210000,
  MeteoriteStaff = 33250000,
  CarianRegalScepter = 33090000,
  AlbinauricStaff = 33190000,
  PrinceOfDeathsStaff = 33180000,
  CarianGlintbladeStaff = 33170000,
  StaffOfLoss = 33280000,
  FingerSeal = 34000000,
  GodslayersSeal = 34010000,
  GiantsSeal = 34020000,
  GravelStoneSeal = 34030000,
  ClawmarkSeal = 34040000,
  GoldenOrderSeal = 34060000,
  AzursGlintstoneStaff = 33230000,
  LusatsGlintstoneStaff = 33240000,
  RottenCrystalStaff = 33270000,
  CompositeBow = 40050000,
  RedBranchShortbow = 40020000,
  AlbinauricBow = 41010000,
  HornBow = 41020000,
  MisbegottenShortbow = 40010000,
  Shortbow = 40000000,
  GolemGreatbow = 42010000,
  LionGreatbow = 42000000,
  Longbow = 41000000,
  HarpBow = 40030000,
  ErdtreeBow = 41030000,
  SerpentBow = 41040000,
  ErdtreeGreatbow = 42030000,
  BlackBow = 41070000,
  PulleyBow = 41060000,
  Greatbow = 42040000,
  SoldiersCrossbow = 43000000,
  LightCrossbow = 43020000,
  Arbalest = 43080000,
  PulleyCrossbow = 43050000,
  HandBallista = 44000000,
  JarCannon = 44010000,
  HeavyCrossbow = 43030000,
  FullMoonCrossbow = 43060000,
  CrepussBlackKeyCrossbow = 43110000,
  MarredWoodenShield = 31020000,
  BanishedKnightsShield = 31030000,
  DragonclawShield = 32040000,
  AlbinauricShield = 31040000,
  SunRealmShield = 31050000,
  RicketyShield = 30030000,
  WoodenGreatshield = 32290000,
  DistinguishedGreatshield = 32020000,
  CrucibleHornshield = 32030000,
  SilverMirrorshield = 31060000,
  RoundShield = 31070000,
  HeaterShield = 31330000,
  GreatTurtleShell = 31140000,
  ShieldOfTheGuilty = 31170000,
  CarianKnightsShield = 31190000,
  BlueGoldKiteShield = 31100000,
  ScorpionKiteShield = 31080000,
  TwinbirdKiteShield = 31090000,
  KiteShield = 31000000,
  InvertedHawkHeaterShield = 31320000,
  EclipseCrestHeaterShield = 31310000,
  BlueCrestHeaterShield = 31300000,
  RedCrestHeaterShield = 31290000,
  BeastCrestHeaterShield = 31280000,
  HawkCrestWoodenShield = 31270000,
  FlameCrestWoodenShield = 31260000,
  CandletreeWoodenShield = 31250000,
  HorseCrestWoodenShield = 31240000,
  LargeLeatherShield = 31230000,
  BlackLeatherShield = 31340000,
  Buckler = 30000000,
  MarredLeatherShield = 31010000,
  PerfumersShield = 30010000,
  ManSerpentsShield = 30020000,
  PilloryShield = 30040000,
  RedThornRoundshield = 30070000,
  ScriptureWoodenShield = 30080000,
  RivetedWoodenShield = 30090000,
  BlueWhiteWoodenShield = 30100000,
  CoilShield = 30200000,
  SpiralhornShield = 30190000,
  RiftShield = 30110000,
  IronRoundshield = 30120000,
  GildedIronShield = 30130000,
  IceCrestShield = 30140000,
  SmolderingShield = 30150000,
  BriarGreatshield = 32050000,
  BrassShield = 31130000,
  ErdtreeGreatshield = 32080000,
  GoldenBeastCrestShield = 32090000,
  DragonTowershield = 32000000,
  JellyfishShield = 32120000,
  FingerprintStoneShield = 32130000,
  IconShield = 32140000,
  OneEyedShield = 32150000,
  SpikedPalisadeShield = 32170000,
  VisageShield = 32160000,
  ManorTowershield = 32190000,
  CrossedTreeTowershield = 32200000,
  InvertedHawkTowershield = 32210000,
  AntsSkullPlate = 32220000,
  RedmaneGreatshield = 32230000,
  EclipseCrestGreatshield = 32240000,
  CuckooGreatshield = 32250000,
  GoldenGreatshield = 32260000,
  GildedGreatshield = 32270000,
  HaligtreeCrestGreatshield = 32280000,
  LordswornsShield = 32300000,
  Torch = 24000000,
  Torchpole = 16080000,
  SteelWireTorch = 24020000,
  StTrinasTorch = 24040000,
  GhostflameTorch = 24050000,
  SentrysTorch = 24070000,
  EnvoysHorn = 11100000,
  EnvoysLongHorn = 12160000,
  EnvoysGreathorn = 23030000,
  BeastmansJarShield = 30060000,
  MainGauche = 4916000,
  FireKnightsShortsword = 4632000,
  VelvetSwordOfStTrina = 4348000,
  StarLinedSword = 4064000,
  CarianSorcerySword = 3780000,
  StoneSheathedSword = 3496000,
  SwordOfLight = 3212000,
  SwordOfDarkness = 2928000,
  SwordLance = 2644000,
  GreatswordOfDamnation = 2360000,
  LizardGreatsword = 2076000,
  GreatswordOfSolitude = 1792000,
  AncientMeteoricOreGreatsword = 1508000,
  FireKnightsGreatsword = 1224000,
  GreatswordOfRadahnLord = 940000,
  QueelignsGreatsword = 656000,
  SpiritSword = 372000,
  Falx = 88000,
  DancingBladeOfRanah = -196000,
  HornedWarriorsSword = -480000,
  PutrescenceCleaver = -764000,
  FreyjasGreatsword = -1048000,
  HornedWarriorsGreatsword = -1332000,
  SwordOfNight = -1616000,
  Euporia = -1900000,
  BlackSteelTwinblade = -2184000,
  FlowerstoneGavel = -2468000,
  SmithscriptGreathammer = -2752000,
  AnvilHammer = -3036000,
  BlackSteelGreathammer = -3320000,
  BloodfiendsArm = -3604000,
  SerpentFlail = -3888000,
  SmithscriptAxe = -4172000,
  DeathKnightsTwinAxes = -4456000,
  MessmerSoldiersAxe = -4740000,
  ForkedTongueHatchet = -5024000,
  DeathKnightsLonghaftAxe = -5308000,
  SmithscriptSpear = -5592000,
  SwiftSpear = -5876000,
  BloodfiendsFork = -6160000,
  SpearOfTheImpaler = -6444000,
  BarbedStaffSpear = -6728000,
  SpiritGlaive = -7012000,
  PolebladeOfTheBud = -7296000,
  ObsidianLamina = -7580000,
  ToothWhip = -7864000,
  ThiolliersHiddenNeedle = -8148000,
  Pata = -8432000,
  PoisonedHand = -8716000,
  MaddingHand = -9000000,
  GolemFist = -9284000,
  ShieldOfNight = -9568000,
  ClawsOfNight = -9852000,
  DevoniasHammer = -10136000,
  ShadowSunflowerBlossom = -10420000,
  GazingFinger = -10704000,
  NanayasTorch = -10988000,
  LamentingVisage = -11272000,
  SmithscriptShield = -11556000,
  MessmerSoldierShield = -11840000,
  WolfCrestShield = -12124000,
  SerpentCrestShield = -12408000,
  GoldenLionShield = -12692000,
  BlackSteelGreatshield = -12976000,
  VerdigrisGreatshield = -13260000,
  StaffOfTheGreatBeyond = -13544000,
  MaternalStaff = -13828000,
  DryleafSeal = -14112000,
  FireKnightsSeal = -14396000,
  SpiraltreeSeal = -14680000,
  AnsbachsLongbow = -14964000,
  IgonsGreatbow = -15248000,
  RepeatingCrossbow = -15532000,
  SpreadCrossbow = -15816000,
  RabbathsCannon = -16100000,
  DryleafArts = -16384000,
  FiresparkPerfumeBottle = -16668000,
  ChillingPerfumeBottle = -16952000,
  FrenzyflamePerfumeBottle = -17236000,
  LightningPerfumeBottle = -17520000,
  DeadlyPoisonPerfumeBottle = -17804000,
  DuelingShield = -18088000,
  CarianThrustingShield = -18372000,
  SmithscriptDagger = -18656000,
  BackhandBlade = -18940000,
  SmithscriptCirque = -19224000,
  CursebladesCirque = -19508000,
  GreatKatana = -19792000,
  DragonHuntersGreatKatana = -20076000,
  RakshasasGreatKatana = -20360000,
  Milady = -20644000,
  LedasSword = -20928000,
  RellanasTwinBlades = -21212000,
  BeastClaw = -21496000,
}

export enum RequestType {
  ReloadFXR = 0,
  SetResidentSFX = 1,
}

export type ReloaderResponse = {
  requestID: string
  status: string
}

export interface ReloadParams {
  /**
   * An ArrayBuffer or typed array containing the contents of the FXR file.
   */
  buffer: ArrayBuffer | ArrayBufferView
  /**
   * If set to true, this will disable the resident SFX on a {@link weapon}
   * for a short time and then enable it again, effectively respawning the SFX.
   * This allows an SFX attached to a weapon to automatically update without
   * manual interaction with the game.
   * 
   * **Default**: false
   */
  respawn?: boolean
  /**
   * When {@link respawn} is enabled, this is the numerical ID for the weapon
   * to change the resident SFX of.
   * 
   * **Default**: 24050000 (Ghostflame Torch)
   */
  weapon?: number
  /**
   * When {@link respawn} is enabled, this is the ID of the dummy poly to
   * attach the SFX to.
   * 
   * **Default**: 206
   */
  dummyPoly?: number
  /**
   * When {@link respawn} is enabled, this is the number of milliseconds to
   * wait after disabling the resident SFX before setting it back to the SFX
   * ID.
   * 
   * **Default**: 100
   */
  wait?: number
}

export interface WSLikeWebSocket {
  on(type: keyof WebSocketEventMap, listener: (data: string) => void): void
  on(type: 'error', listener: (err: any) => void): void
  send(msg: string): void
  close(): void
}

export interface WSLikeWebSocketConstructor {
  new(url: string): WSLikeWebSocket
}

export type FXRReloader = {
  /**
   * A WebSocket connected to fxr-ws-reloader.dll.
   */
  readonly ws: WSLikeWebSocket
  /**
   * Makes a request to fxr-ws-reloader.dll to do something. This is used
   * internally to make the necessary requests to reload FXRs.
   */
  request(obj: any): Promise<void>
  /**
   * Reload an FXR, and optionally respawn it as a resident SFX of a given
   * weapon.
   */
  reload(obj: ReloadParams): Promise<void>
}

const requestMap = new Map<string, (res: ReloaderResponse) => void>

/**
 * Connects to a WebSocket server and sets up the necessary event handlers for
 * reloading FXRs.
 * @param portOrURL The port number or URL string to connect to. By default, it
 * will try to connect to `ws://localhost:24621`, and setting only the port
 * will just replace the port number.
 */
export function connect(WebSocketClass: WSLikeWebSocketConstructor, portOrURL: number | string = 24621) {
  const url = typeof portOrURL === 'number' ?
    `ws://localhost:${portOrURL}` :
    portOrURL
  const ws = new WebSocketClass(url)
  ws.on('message', (data: string) => {
    const res: ReloaderResponse = JSON.parse(data)
    if (requestMap.has(res.requestID)) {
      ;(requestMap.get(res.requestID) as (res: ReloaderResponse) => void)(res)
      requestMap.delete(res.requestID)
    }
  })
  return new Promise<FXRReloader>((fulfil, reject) => {
    ws.on('error', (err: any) => {
      console.error(
        'Failed to connect to WebSocket server!',
        'Is the game running, and is the DLL mod installed?'
      )
      reject(err)
    })
    ws.on('open', () => {
      fulfil({
        ws,
        request(obj: any) { return request(ws, obj) },
        reload(obj: ReloadParams) { return reload(ws, obj) }
      })
    })
  })
}

function randomString(length: number) {
  return Array.from(crypto.getRandomValues(new Uint32Array(length)))
    .map(n =>
      'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'[n%62]
    )
    .join('')
}

/**
 * Makes a request to fxr-ws-reloader.dll to do something. This is used
 * internally to make the necessary requests to reload FXRs.
 */
export function request(ws: WSLikeWebSocket, obj: any) {
  let id = randomString(32)
  while (requestMap.has(id)) {
    id = randomString(32)
  }
  ws.send(JSON.stringify(Object.assign({}, obj, { requestID: id })))
  return new Promise<void>((fulfil, reject) =>
    requestMap.set(id, (res: ReloaderResponse) => {
      if (res.status === 'success') {
        fulfil()
      } else {
        reject(res.status)
      }
    })
  )
}

async function bufferToBase64(buffer: ArrayBuffer | ArrayBufferView) {
  try {
    if (ArrayBuffer.isView(buffer)) {
      return Buffer.from(buffer.buffer).toString('base64')
    }
    return Buffer.from(buffer).toString('base64')
  } catch {
    const base64url = await new Promise<string>(fulfil => {
      const reader = new FileReader()
      reader.onload = () => fulfil(reader.result as string)
      reader.readAsDataURL(new Blob([ buffer ]))
    })
    return base64url.slice(base64url.indexOf(',') + 1)
  }
}

/**
 * Reload an FXR, and optionally respawn it as a resident SFX of a given
 * weapon.
 * @param ws A WebSocket connected to fxr-ws-reloader.dll.
 */
export async function reload(ws: WSLikeWebSocket, {
  buffer,
  respawn,
  wait = 100,
  weapon = Weapon.ShortSword,
  dummyPoly = 120
}: ReloadParams) {
  // Reload the FXR
  await request(ws, {
    type: RequestType.ReloadFXR,
    file: await bufferToBase64(buffer)
  })

  if (respawn) {
    // Remove the weapon's resident SFX
    await request(ws, {
      type: RequestType.SetResidentSFX,
      weapon,
      sfx: -1,
      dmy: -1,
    })

    // Wait for a short while before setting the SFX ID
    await new Promise(f => setTimeout(f, wait))

    // Set the resident SFX ID to the ID in the FXR
    const dv = new DataView(
      buffer instanceof ArrayBuffer ? buffer : buffer.buffer
    )
    await request(ws, {
      type: RequestType.SetResidentSFX,
      weapon,
      sfx: dv.getInt32(12, true),
      dmy: dummyPoly,
    })
  }
}

export default async function reloadFXR(
  WebSocketClass: WSLikeWebSocketConstructor,
  buffer: ArrayBuffer | ArrayBufferView,
  respawn?: boolean,
  weapon?: number,
  dummyPoly?: number,
  portOrURL?: number | string,
) {
  const reloader = await connect(WebSocketClass, portOrURL)
  await reloader.reload({
    buffer,
    respawn,
    weapon,
    dummyPoly,
  })
  reloader.ws.close()
}
